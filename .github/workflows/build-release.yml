name: Build Multi-Platform Binaries

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-22.04
            boost_version: 1.87.0
          - arch: aarch64
            runner: ubuntu-22.04-arm
            boost_version: 1.87.0
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Install dependencies
        run: |
          BOOST_VER_UNDERSCORE=$(echo ${{ matrix.boost_version }} | tr . _)
          sudo apt-get update && sudo apt-get install -y build-essential cmake wget git libssl-dev zlib1g-dev
          mkdir -p dependencies && cd dependencies
          wget -q https://archives.boost.io/release/${{ matrix.boost_version }}/source/boost_${BOOST_VER_UNDERSCORE}.tar.gz -O boost.tar.gz
          tar xzf boost.tar.gz && cd boost_${BOOST_VER_UNDERSCORE} && ./bootstrap.sh && sudo ./b2 install link=static -j$(nproc)
          cd .. && wget -q https://github.com/protocolbuffers/protobuf/releases/download/v3.17.3/protobuf-all-3.17.3.tar.gz -O protobuf.tar.gz
          tar xzf protobuf.tar.gz && cd protobuf-3.17.3 && mkdir -p build && cd build && cmake ../cmake && make -j$(nproc) && sudo make install
      
      - name: Build
        run: |
          mkdir -p build && cd build && cmake .. -DLINK_STATIC_OPENSSL=OFF && make -j$(nproc)
          strip bin/localproxy
      
      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: localproxy-linux-${{ matrix.arch }}
          path: build/bin/localproxy

  build-linux-arm32:
    permissions:
      contents: read
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      - name: Cache ARM32 dependencies
        id: cache-arm32
        uses: actions/cache@v5
        with:
          path: arm32-deps
          key: arm32-deps-boost1.87-protobuf3.17.3-v1

      - name: Build dependencies in ARM32 container
        if: steps.cache-arm32.outputs.cache-hit != 'true'
        run: |
          mkdir -p arm32-deps
          docker run --rm --platform linux/arm/v7 \
            -v ${{ github.workspace }}/arm32-deps:/deps \
            arm32v7/ubuntu:22.04 bash -c '
              apt-get update && apt-get install -y build-essential cmake wget
              wget -q https://archives.boost.io/release/1.87.0/source/boost_1_87_0.tar.gz -O /tmp/boost.tar.gz
              tar xzf /tmp/boost.tar.gz -C /tmp && cd /tmp/boost_1_87_0
              ./bootstrap.sh --prefix=/deps --with-libraries=system,log,thread,program_options,date_time,filesystem,chrono
              ./b2 install link=static -j$(nproc)
              wget -q https://github.com/protocolbuffers/protobuf/releases/download/v3.17.3/protobuf-all-3.17.3.tar.gz -O /tmp/protobuf.tar.gz
              tar xzf /tmp/protobuf.tar.gz -C /tmp && cd /tmp/protobuf-3.17.3
              mkdir build && cd build && cmake ../cmake -DCMAKE_INSTALL_PREFIX=/deps -Dprotobuf_BUILD_TESTS=OFF
              make -j$(nproc) && make install
            '

      - name: Build localproxy in ARM32 container
        run: |
          docker run --rm --platform linux/arm/v7 \
            -v ${{ github.workspace }}:/src \
            -v ${{ github.workspace }}/arm32-deps:/deps \
            -w /src \
            arm32v7/ubuntu:22.04 bash -c '
              apt-get update && apt-get install -y build-essential cmake libssl-dev zlib1g-dev
              mkdir -p build && cd build
              cmake .. -DCMAKE_PREFIX_PATH=/deps -DLINK_STATIC_OPENSSL=OFF -DBOOST_PKG_VERSION="" -DPROTOBUF_PKG_VERSION=""
              make -j$(nproc)
              strip bin/localproxy
            '

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: localproxy-linux-armv7
          path: build/bin/localproxy

  build-macos:
    permissions:
      contents: read
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Install system dependencies
        run: brew install cmake openssl@3 zlib
      
      - name: Install Boost
        run: |
          mkdir -p $HOME/dependencies
          cd $HOME/dependencies
          wget -q https://archives.boost.io/release/1.87.0/source/boost_1_87_0.tar.gz -O boost.tar.gz
          tar xzf boost.tar.gz
          cd boost_1_87_0
          ./bootstrap.sh
          sudo ./b2 install link=static -j$(sysctl -n hw.ncpu)
      
      - name: Install Protobuf
        run: |
          cd $HOME/dependencies
          wget -q https://github.com/protocolbuffers/protobuf/releases/download/v3.17.3/protobuf-all-3.17.3.tar.gz -O protobuf.tar.gz
          tar xzf protobuf.tar.gz
          cd protobuf-3.17.3
          rm -rf build
          mkdir build
          cd build
          cmake ../cmake -DCMAKE_PREFIX_PATH=$(brew --prefix openssl@3) -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          make -j$(sysctl -n hw.ncpu)
          sudo make install
      
      - name: Build
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_PREFIX_PATH=$(brew --prefix openssl@3) -DLINK_STATIC_OPENSSL=OFF
          make -j$(sysctl -n hw.ncpu)
          strip bin/localproxy
      
      # Note: Binary is not code-signed. macOS users may need to run:
      # xattr -d com.apple.quarantine localproxy-macos-arm64
      # Or right-click the binary and select "Open" to bypass Gatekeeper
      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: localproxy-macos-arm64
          path: build/bin/localproxy

  build-windows:
    permissions:
      contents: read
    runs-on: windows-2025
    env:
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}\vcpkg-cache
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Cache vcpkg packages
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}\vcpkg-cache
          key: vcpkg-windows-x64-v1

      - name: Install dependencies
        run: |
          New-Item -ItemType Directory -Force -Path $env:VCPKG_DEFAULT_BINARY_CACHE
          vcpkg install openssl:x64-windows zlib:x64-windows boost:x64-windows protobuf:x64-windows

      - name: Build
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" -DLINK_STATIC_OPENSSL=OFF -DWIN32_WINNT=0x0A00 -DPROTOBUF_PKG_VERSION="" -DBOOST_PKG_VERSION="" -DCMAKE_CXX_STANDARD=17 -DCMAKE_CXX_FLAGS="/std:c++17"
          cmake --build . --config Release

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: localproxy-windows-x64
          path: build/bin/Release/localproxy.exe
