name: Build Multi-Platform Binaries

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-22.04
            boost_version: 1.87.0
          - arch: aarch64
            runner: ubuntu-22.04-arm
            boost_version: 1.87.0
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Install dependencies
        run: |
          BOOST_VER_UNDERSCORE=$(echo ${{ matrix.boost_version }} | tr . _)
          sudo apt-get update && sudo apt-get install -y build-essential cmake wget git libssl-dev zlib1g-dev
          mkdir -p dependencies && cd dependencies
          wget -q https://archives.boost.io/release/${{ matrix.boost_version }}/source/boost_${BOOST_VER_UNDERSCORE}.tar.gz -O boost.tar.gz
          tar xzf boost.tar.gz && cd boost_${BOOST_VER_UNDERSCORE} && ./bootstrap.sh && sudo ./b2 install link=static -j$(nproc)
          cd .. && wget -q https://github.com/protocolbuffers/protobuf/releases/download/v3.17.3/protobuf-all-3.17.3.tar.gz -O protobuf.tar.gz
          tar xzf protobuf.tar.gz && cd protobuf-3.17.3 && mkdir -p build && cd build && cmake ../cmake && make -j$(nproc) && sudo make install
      
      - name: Build
        run: |
          mkdir -p build && cd build && cmake .. -DLINK_STATIC_OPENSSL=OFF && make -j$(nproc)
      
      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: localproxy-linux-${{ matrix.arch }}
          path: build/bin/localproxy

  build-linux-arm32:
    permissions:
      contents: read
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm
      
      - name: Cache ARM32 dependencies
        uses: actions/cache@v5
        with:
          path: |
            dependencies
            arm32-prefix
          key: arm32-deps-boost-1.87.0-protobuf-3.17.3-v3
      
      - name: Build in ARM32 container
        run: |
          docker run --rm --platform linux/arm/v7 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            arm32v7/ubuntu:22.04 bash -c '
            apt-get update && apt-get install -y build-essential cmake wget git libssl-dev zlib1g-dev
            BOOST_VER=1.87.0
            BOOST_VER_UNDERSCORE=$(echo $BOOST_VER | tr . _)
            PREFIX=/workspace/arm32-prefix
            mkdir -p $PREFIX dependencies
            
            # Check if already built
            if [ -f "$PREFIX/lib/libboost_system.a" ] && [ -f "$PREFIX/lib/libprotobuf.a" ]; then
              echo "Using cached dependencies"
            else
              cd /workspace/dependencies
              if [ ! -d "boost_${BOOST_VER_UNDERSCORE}" ]; then
                wget -q https://archives.boost.io/release/$BOOST_VER/source/boost_${BOOST_VER_UNDERSCORE}.tar.gz -O boost.tar.gz
                tar xzf boost.tar.gz
              fi
              cd boost_${BOOST_VER_UNDERSCORE} && ./bootstrap.sh --prefix=$PREFIX && ./b2 install link=static -j$(nproc)
              
              cd /workspace/dependencies
              if [ ! -d "protobuf-3.17.3" ]; then
                wget -q https://github.com/protocolbuffers/protobuf/releases/download/v3.17.3/protobuf-all-3.17.3.tar.gz -O protobuf.tar.gz
                tar xzf protobuf.tar.gz
              fi
              cd protobuf-3.17.3 && rm -rf build && mkdir -p build && cd build && cmake ../cmake -DCMAKE_INSTALL_PREFIX=$PREFIX && make -j$(nproc) && make install
            fi
            
            cd /workspace && rm -rf build && mkdir -p build && cd build
            cmake .. -DLINK_STATIC_OPENSSL=OFF -DCMAKE_PREFIX_PATH=$PREFIX -DProtobuf_ROOT=$PREFIX
            make -j$(nproc)
          '
      
      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: localproxy-linux-armv7
          path: build/bin/localproxy

  build-macos:
    permissions:
      contents: read
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Install system dependencies
        run: brew install cmake openssl@3 zlib
      
      - name: Install Boost
        run: |
          mkdir -p $HOME/dependencies
          cd $HOME/dependencies
          wget -q https://archives.boost.io/release/1.87.0/source/boost_1_87_0.tar.gz -O boost.tar.gz
          tar xzf boost.tar.gz
          cd boost_1_87_0
          ./bootstrap.sh
          sudo ./b2 install link=static -j$(sysctl -n hw.ncpu)
      
      - name: Install Protobuf
        run: |
          cd $HOME/dependencies
          wget -q https://github.com/protocolbuffers/protobuf/releases/download/v3.17.3/protobuf-all-3.17.3.tar.gz -O protobuf.tar.gz
          tar xzf protobuf.tar.gz
          cd protobuf-3.17.3
          rm -rf build
          mkdir build
          cd build
          cmake ../cmake -DCMAKE_PREFIX_PATH=$(brew --prefix openssl@3) -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          make -j$(sysctl -n hw.ncpu)
          sudo make install
      
      - name: Build
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_PREFIX_PATH=$(brew --prefix openssl@3) -DLINK_STATIC_OPENSSL=OFF
          make -j$(sysctl -n hw.ncpu)
      
      # Note: Binary is not code-signed. macOS users may need to run:
      # xattr -d com.apple.quarantine localproxy-macos-arm64
      # Or right-click the binary and select "Open" to bypass Gatekeeper
      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: localproxy-macos-arm64
          path: build/bin/localproxy

  build-windows:
    permissions:
      contents: read
    strategy:
      matrix:
        arch: [x64, ARM64]
    runs-on: windows-2025
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}
      
      - name: Cache vcpkg dependencies
        uses: actions/cache@v5
        with:
          path: |
            ${{ env.VCPKG_ROOT }}/installed
            ${{ env.VCPKG_ROOT }}/packages
          key: windows-${{ matrix.arch }}-vcpkg-boost-protobuf-openssl-zlib-v1
      
      - name: Install dependencies via vcpkg
        run: |
          $triplet = if ("${{ matrix.arch }}" -eq "x64") { "x64-windows" } else { "arm64-windows" }
          vcpkg install boost-asio:$triplet boost-bind:$triplet boost-log:$triplet boost-program-options:$triplet boost-system:$triplet protobuf:$triplet openssl:$triplet zlib:$triplet
          vcpkg integrate install
        shell: pwsh
      
      - name: Build
        run: |
          $triplet = if ("${{ matrix.arch }}" -eq "x64") { "x64-windows" } else { "arm64-windows" }
          $platform = if ("${{ matrix.arch }}" -eq "x64") { "x64" } else { "ARM64" }
          mkdir build -Force
          cd build
          cmake .. -DCMAKE_TOOLCHAIN_FILE="$Env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" -A $platform -DVCPKG_TARGET_TRIPLET=$triplet -DLINK_STATIC_OPENSSL=OFF
          cmake --build . --config Release --parallel
        shell: pwsh
      
      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: localproxy-windows-${{ matrix.arch }}
          path: build/bin/Release/localproxy.exe
