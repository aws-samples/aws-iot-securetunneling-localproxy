name: Build Multi-Platform Binaries

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-24.04
            boost_version: 1.87.0
          - arch: aarch64
            runner: ubuntu-24.04-arm
            boost_version: 1.87.0
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/deps-cache
          key: linux-${{ matrix.arch }}-deps-boost-${{ matrix.boost_version }}-protobuf-3.17.3
      
      - name: Restore cached dependencies
        run: |
          if [ -d ~/deps-cache/lib ]; then
            sudo cp -r ~/deps-cache/lib/* /usr/local/lib/
            sudo cp -r ~/deps-cache/include/* /usr/local/include/
          fi
      
      - name: Install dependencies
        run: |
          BOOST_VER_UNDERSCORE=$(echo ${{ matrix.boost_version }} | tr . _)
          sudo apt-get update && sudo apt-get install -y build-essential cmake wget git libssl-dev zlib1g-dev
          mkdir -p dependencies && cd dependencies
          wget -q https://archives.boost.io/release/${{ matrix.boost_version }}/source/boost_${BOOST_VER_UNDERSCORE}.tar.gz -O boost.tar.gz
          tar xzf boost.tar.gz && cd boost_${BOOST_VER_UNDERSCORE} && ./bootstrap.sh && sudo ./b2 install link=static -j$(nproc)
          cd .. && wget -q https://github.com/protocolbuffers/protobuf/releases/download/v3.17.3/protobuf-all-3.17.3.tar.gz -O protobuf.tar.gz
          tar xzf protobuf.tar.gz && cd protobuf-3.17.3 && mkdir -p build && cd build && cmake ../cmake && make -j$(nproc) && sudo make install
      
      - name: Save dependencies to cache
        run: |
          mkdir -p ~/deps-cache/lib ~/deps-cache/include
          cp -r /usr/local/lib/libboost_* ~/deps-cache/lib/ 2>/dev/null || true
          cp -r /usr/local/lib/libprotobuf* ~/deps-cache/lib/ 2>/dev/null || true
          cp -r /usr/local/include/boost ~/deps-cache/include/ 2>/dev/null || true
          cp -r /usr/local/include/google ~/deps-cache/include/ 2>/dev/null || true
      
      - name: Build
        run: |
          mkdir -p build && cd build && cmake .. && make -j$(nproc)
      
      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: localproxy-linux-${{ matrix.arch }}
          path: build/bin/localproxy

  build-linux-arm32:
    permissions:
      contents: read
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm
      
      - name: Build in ARM32 container
        run: |
          docker run --rm --platform linux/arm/v7 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            arm32v7/ubuntu:22.04 bash -c '
            apt-get update && apt-get install -y build-essential cmake wget git libssl-dev zlib1g-dev
            BOOST_VER=1.87.0
            BOOST_VER_UNDERSCORE=$(echo $BOOST_VER | tr . _)
            mkdir -p dependencies && cd dependencies
            wget -q https://archives.boost.io/release/$BOOST_VER/source/boost_${BOOST_VER_UNDERSCORE}.tar.gz -O boost.tar.gz
            tar xzf boost.tar.gz && cd boost_${BOOST_VER_UNDERSCORE} && ./bootstrap.sh && ./b2 install link=static -j$(nproc)
            cd .. && wget -q https://github.com/protocolbuffers/protobuf/releases/download/v3.17.3/protobuf-all-3.17.3.tar.gz -O protobuf.tar.gz
            tar xzf protobuf.tar.gz && cd protobuf-3.17.3 && mkdir -p build && cd build && cmake ../cmake && make -j$(nproc) && make install
            cd /workspace && mkdir -p build && cd build && cmake .. && make -j$(nproc)
          '
      
      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: localproxy-linux-armv7
          path: build/bin/localproxy

  build-macos:
    permissions:
      contents: read
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/deps-cache
          key: macos-arm64-deps-boost-1.87.0-protobuf-3.17.3
      
      - name: Restore cached dependencies
        run: |
          if [ -d ~/deps-cache/lib ]; then
            sudo cp -r ~/deps-cache/lib/* /usr/local/lib/
            sudo cp -r ~/deps-cache/include/* /usr/local/include/
          fi
      
      - name: Install system dependencies
        run: brew install cmake openssl@3 zlib
      
      - name: Install Boost
        run: |
          mkdir -p $HOME/dependencies
          cd $HOME/dependencies
          wget -q https://archives.boost.io/release/1.87.0/source/boost_1_87_0.tar.gz -O boost.tar.gz
          tar xzf boost.tar.gz
          cd boost_1_87_0
          ./bootstrap.sh
          sudo ./b2 install link=static -j$(sysctl -n hw.ncpu)
      
      - name: Install Protobuf
        run: |
          cd $HOME/dependencies
          wget -q https://github.com/protocolbuffers/protobuf/releases/download/v3.17.3/protobuf-all-3.17.3.tar.gz -O protobuf.tar.gz
          tar xzf protobuf.tar.gz
          cd protobuf-3.17.3
          rm -rf build
          mkdir build
          cd build
          cmake ../cmake -DCMAKE_PREFIX_PATH=$(brew --prefix openssl@3) -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          make -j$(sysctl -n hw.ncpu)
          sudo make install
      
      - name: Save dependencies to cache
        run: |
          mkdir -p ~/deps-cache/lib ~/deps-cache/include
          cp -r /usr/local/lib/libboost_* ~/deps-cache/lib/ 2>/dev/null || true
          cp -r /usr/local/lib/libprotobuf* ~/deps-cache/lib/ 2>/dev/null || true
          cp -r /usr/local/include/boost ~/deps-cache/include/ 2>/dev/null || true
          cp -r /usr/local/include/google ~/deps-cache/include/ 2>/dev/null || true
      
      - name: Build
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_PREFIX_PATH=$(brew --prefix openssl@3)
          make -j$(sysctl -n hw.ncpu)
      
      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: localproxy-macos-arm64
          path: build/bin/localproxy

  build-windows:
    permissions:
      contents: read
    strategy:
      matrix:
        arch: [x64, ARM64]
    runs-on: windows-2025
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}
      
      - name: Cache vcpkg dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.VCPKG_ROOT }}/installed
            ${{ env.VCPKG_ROOT }}/packages
          key: windows-${{ matrix.arch }}-vcpkg-boost-protobuf-openssl-zlib-v1
      
      - name: Install dependencies via vcpkg
        run: |
          $triplet = if ("${{ matrix.arch }}" -eq "x64") { "x64-windows" } else { "arm64-windows" }
          vcpkg install boost-asio:$triplet boost-bind:$triplet boost-log:$triplet boost-program-options:$triplet boost-system:$triplet protobuf:$triplet openssl:$triplet zlib:$triplet
          vcpkg integrate install
        shell: pwsh
      
      - name: Build
        run: |
          $triplet = if ("${{ matrix.arch }}" -eq "x64") { "x64-windows" } else { "arm64-windows" }
          $platform = if ("${{ matrix.arch }}" -eq "x64") { "x64" } else { "ARM64" }
          mkdir build -Force
          cd build
          cmake .. -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" -A $platform -DVCPKG_TARGET_TRIPLET=$triplet
          cmake --build . --config Release --parallel
        shell: pwsh
      
      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: localproxy-windows-${{ matrix.arch }}
          path: build/bin/Release/localproxy.exe
